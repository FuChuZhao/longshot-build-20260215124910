name: android-emulator-test

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Private SOURCE_REPO (owner/name)"
        required: true
        type: string
      source_ref:
        description: "Ref or commit in SOURCE_REPO"
        required: true
        default: "main"
        type: string
      artifact_name:
        description: "Artifact name"
        required: true
        default: "android-test-artifacts"
        type: string
      suite:
        description: "Scenario suite label"
        required: true
        default: "plain"
        type: choice
        options:
          - plain
          - dynamic
          - web
          - protocol
          - mimic
          - stress_boundary

permissions:
  contents: read

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    steps:
      - name: Checkout build workflow repo
        uses: actions/checkout@v4

      - name: Configure SSH for private source clone
        env:
          SOURCE_REPO_SSH_KEY: ${{ secrets.SOURCE_REPO_SSH_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$SOURCE_REPO_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private source repository
        run: |
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM access
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -l /dev/kvm || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Assemble APKs before emulator start
        run: |
          bash -lc "cd source && timeout 25m gradle --no-daemon \
            :apps:longshot:assembleDebug \
            :apps:scenelab:assembleDebug \
            :apps:visualrecorder:assembleDebug \
            :qa:uiauto:assembleDebug \
            :qa:uiauto:assembleDebugAndroidTest"

      - name: Prepare artifact workspace
        run: |
          mkdir -p source/out/test-artifacts
          echo "workflow_started_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > source/out/test-artifacts/workflow-heartbeat.txt

      - name: Run instrumentation on emulator (manual)
        env:
          SUITE: ${{ inputs.suite }}
        run: |
          set -euo pipefail

          ART_DIR="source/out/test-artifacts"
          EMU_LOG="${ART_DIR}/emulator.log"
          BOOT_LOG="${ART_DIR}/emulator-boot.txt"
          RUNTIME_LOG="${ART_DIR}/workflow-runtime.log"

          mkdir -p "${ART_DIR}"
          : > "${EMU_LOG}"
          : > "${BOOT_LOG}"
          : > "${RUNTIME_LOG}"

          log() {
            echo "[$(date -u +'%Y-%m-%dT%H:%M:%SZ')] $*" | tee -a "${RUNTIME_LOG}"
          }

          dump_diag() {
            log "diag: adb devices"
            adb devices -l | tee -a "${BOOT_LOG}" || true
            log "diag: emulator log tail"
            tail -n 160 "${EMU_LOG}" | tee -a "${BOOT_LOG}" || true
          }

          wait_for_adb_device() {
            local timeout_secs="${1:-300}"
            local start_ts current_ts serial
            start_ts="$(date +%s)"
            while true; do
              serial="$(adb devices | awk 'NR>1 && $2 == "device" && $1 ~ /^emulator-/ {print $1; exit}')"
              if [[ -n "${serial}" ]]; then
                printf '%s' "${serial}"
                return 0
              fi
              current_ts="$(date +%s)"
              if (( current_ts - start_ts >= timeout_secs )); then
                return 1
              fi
              sleep 2
            done
          }

          wait_for_prop() {
            local prop="$1"
            local expected="$2"
            local timeout_secs="$3"
            local start_ts current_ts value
            start_ts="$(date +%s)"
            while true; do
              value="$(adb -s "${ANDROID_SERIAL}" shell getprop "${prop}" 2>/dev/null | tr -d '\r')"
              if [[ "${value}" == "${expected}" ]]; then
                return 0
              fi
              current_ts="$(date +%s)"
              if (( current_ts - start_ts >= timeout_secs )); then
                log "timeout waiting prop ${prop}=${expected}, current=${value}"
                return 1
              fi
              sleep 2
            done
          }

          on_error() {
            dump_diag
          }
          trap on_error ERR

          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME}}"
          export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator:${PATH}"
          export ANDROID_SDK_HOME="${GITHUB_WORKSPACE}/.ci-android-home"
          export ANDROID_AVD_HOME="${ANDROID_SDK_HOME}/avd"
          mkdir -p "${ANDROID_AVD_HOME}"

          log "accept sdk licenses"
          yes | sdkmanager --licenses >/dev/null || true
          log "install emulator dependencies"
          timeout 20m sdkmanager --install \
            "platform-tools" \
            "emulator" \
            "platforms;android-35" \
            "system-images;android-35;default;x86_64"

          log "create avd"
          echo "no" | avdmanager create avd -f -n ci_api35 -k "system-images;android-35;default;x86_64" --device "pixel_7" --path "${ANDROID_AVD_HOME}/ci_api35"
          AVAILABLE_AVDS="$(emulator -list-avds || true)"
          printf '%s\n' "${AVAILABLE_AVDS}" | tee -a "${RUNTIME_LOG}"
          if ! grep -qx "ci_api35" <<< "${AVAILABLE_AVDS}"; then
            log "avd ci_api35 missing after creation"
            find "${ANDROID_SDK_HOME}" -maxdepth 3 -type f | head -n 120 | tee -a "${BOOT_LOG}" || true
            exit 1
          fi

          log "start emulator process"
          emulator -avd ci_api35 \
            -no-window -noaudio \
            -gpu swiftshader_indirect \
            -camera-back none -camera-front none \
            -no-boot-anim -no-snapshot-load -no-snapshot-save -wipe-data \
            >"${EMU_LOG}" 2>&1 &
          EMU_PID=$!

          cleanup() {
            adb -s "${ANDROID_SERIAL:-emulator-5554}" emu kill >/dev/null 2>&1 || adb -e emu kill >/dev/null 2>&1 || true
            wait "${EMU_PID}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          adb start-server
          log "wait for emulator adb registration"
          ANDROID_SERIAL="$(wait_for_adb_device 360)"
          export ANDROID_SERIAL
          log "emulator serial=${ANDROID_SERIAL}"

          timeout 2m adb -s "${ANDROID_SERIAL}" wait-for-device
          wait_for_prop "sys.boot_completed" "1" 420
          wait_for_prop "init.svc.bootanim" "stopped" 240

          {
            echo "serial=${ANDROID_SERIAL}"
            echo "boot_completed=$(adb -s "${ANDROID_SERIAL}" shell getprop sys.boot_completed | tr -d '\r')"
            echo "bootanim=$(adb -s "${ANDROID_SERIAL}" shell getprop init.svc.bootanim | tr -d '\r')"
            adb -s "${ANDROID_SERIAL}" shell service list | head -n 40 || true
          } >"${BOOT_LOG}" 2>&1

          log "run instrumentation suite=${SUITE}"
          timeout 20m bash -lc "cd source && SUITE=${SUITE} SKIP_ASSEMBLE=1 OUT_DIR=out/test-artifacts bash tool/ci/run_emulator_tests.sh"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: source/out/test-artifacts
          if-no-files-found: warn
          retention-days: 1
