name: android-emulator-test

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Private SOURCE_REPO (owner/name)"
        required: true
        type: string
      source_ref:
        description: "Ref or commit in SOURCE_REPO"
        required: true
        default: "main"
        type: string
      artifact_name:
        description: "Artifact name"
        required: true
        default: "android-test-artifacts"
        type: string
      suite:
        description: "Scenario suite label"
        required: true
        default: "plain"
        type: choice
        options:
          - plain
          - dynamic
          - web

permissions:
  contents: read

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    steps:
      - name: Checkout build workflow repo
        uses: actions/checkout@v4

      - name: Configure SSH for private source clone
        env:
          SOURCE_REPO_SSH_KEY: ${{ secrets.SOURCE_REPO_SSH_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$SOURCE_REPO_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private source repository
        run: |
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM access
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -l /dev/kvm || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Assemble APKs before emulator start
        run: |
          bash -lc "cd source && timeout 25m gradle --no-daemon \
            :apps:longshot:assembleDebug \
            :apps:scenelab:assembleDebug \
            :apps:visualrecorder:assembleDebug \
            :qa:uiauto:assembleDebug \
            :qa:uiauto:assembleDebugAndroidTest"

      - name: Prepare artifact workspace
        run: |
          mkdir -p source/out/test-artifacts
          echo "workflow_started_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > source/out/test-artifacts/workflow-heartbeat.txt

      - name: Run instrumentation on emulator (manual)
        env:
          SUITE: ${{ inputs.suite }}
        run: |
          set -euo pipefail

          ART_DIR="source/out/test-artifacts"
          EMU_LOG="${ART_DIR}/emulator.log"
          BOOT_LOG="${ART_DIR}/emulator-boot.txt"

          mkdir -p "${ART_DIR}"
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME}}"
          export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator:${PATH}"

          yes | sdkmanager --licenses >/dev/null || true
          sdkmanager --install \
            "platform-tools" \
            "emulator" \
            "platforms;android-35" \
            "system-images;android-35;default;x86_64"

          echo "no" | avdmanager create avd -f -n ci_api35 -k "system-images;android-35;default;x86_64" --device "pixel_7"

          emulator -avd ci_api35 \
            -no-window -noaudio \
            -gpu swiftshader_indirect \
            -camera-back none -camera-front none \
            -no-boot-anim -no-snapshot-load -no-snapshot-save -wipe-data \
            >"${EMU_LOG}" 2>&1 &
          EMU_PID=$!

          cleanup() {
            adb -e emu kill >/dev/null 2>&1 || true
            wait "${EMU_PID}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          adb start-server
          adb wait-for-device
          timeout 6m bash -lc 'until [[ "$(adb shell getprop sys.boot_completed | tr -d "\r")" == "1" ]]; do sleep 2; done'
          timeout 3m bash -lc 'until [[ "$(adb shell getprop init.svc.bootanim | tr -d "\r")" == "stopped" ]]; do sleep 2; done'

          {
            echo "boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')"
            echo "bootanim=$(adb shell getprop init.svc.bootanim | tr -d '\r')"
            adb shell service list | head -n 40 || true
          } >"${BOOT_LOG}" 2>&1

          bash -lc "cd source && SUITE=${SUITE} SKIP_ASSEMBLE=1 OUT_DIR=out/test-artifacts bash tool/ci/run_emulator_tests.sh"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: source/out/test-artifacts
          if-no-files-found: warn
          retention-days: 1
